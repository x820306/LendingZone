<%- include('layout_header',{searchTitle:null,nav_cur:'story',messengerDefault:'不分訊息狀態',actionDefault:'建立日期',directorDefault:'大至小',keywordDefault:'',categoryDefault:'不分類'}); -%>
<div class="container">
	<div class="row">
		<div class="col-md-9">
			<div class="resp">
				<table width="100%">
					<tr>
						<td style="width:90%;">
							<div class="bigTitle<%if(json.TitleColor==="default"){%> default<%}else if(json.TitleColor==="color1"){%> color1<%}else if(json.TitleColor==="color2"){%> color2<%}else if(json.TitleColor==="color3"){%> color3<%}else if(json.TitleColor==="color4"){%> color4<%}else if(json.TitleColor==="color5"){%> color5<%}else if(json.TitleColor==="color6"){%> color6<%}else if(json.TitleColor==="color7"){%> color7<%}%>"><span class="category">[<%if(json.Category==='general'){%>一般<%}else if(json.Category==='education'){%>教育<%}else if(json.Category==='family'){%>家庭<%}else if(json.Category==='tour'){%>旅遊<%}%>]</span>&nbsp;&nbsp;<%if(json.StoryTitle!==''){%><%-json.StoryTitle.replace(new RegExp(' ','g'),'&nbsp;')%><%}else{%>無標題<%}%></div>
							<div class="subTitle"> by <span id="aiteName"><%=json.CreatedBy.Username%></span></div>
						</td>
						<td nowrap="nowrap" align="right">
							&nbsp;&nbsp;&nbsp;&nbsp;
							<div style="display:inline;" class="myTitle2 m3" id="likeBtn">
								<%if(userName===null){ %>
									<button class="btn btn-default" data-toggle="modal" data-target="#myModal" id="btnID">
										<span class="glyphicon glyphicon-thumbs-up myTitle2"></span>
									</button>
								<% }else{ %>
									<%if(!ifSelf){ %>
										<%if(!ifLiked){ %>
											<button class="btn btn-default" onclick="like();" id="btnID">
												<span class="glyphicon glyphicon-thumbs-up myTitle2"></span>
											</button>
										<% }else{ %>
											<button class="btn btn-default" onclick="unlike();" id="btnID">
												<span class="glyphicon glyphicon-remove myTitle2"></span>
											</button>
										<%}%>
									<% }else{ %>
										<button class="btn btn-default disabled" id="btnID">
											<span class="glyphicon glyphicon-thumbs-up myTitle2"></span>
										</button>
									<%}%>
								<%}%>
							</div>
							<span class="m3 red" id="likeNum">&nbsp;<%=json.LikeNumber%></span>
						</td>
					<tr>
				</table>
			</div>
			<br>
			<ul class="nav nav-tabs" id="myTab">
				<li class="active"><a href="#tab1" data-toggle="tab">故事</a></li>
				<li><a href="#tab2" data-toggle="tab">資訊</a></li>
				<li><a href="#tab3" data-toggle="tab">留言</a></li>
            </ul>
            <div style="height:340px;" class="tab-content my-tab-content">
				<div class="tab-pane active" id="tab1">
					<%if(json.Story!==''){%><%-json.Story.replace(new RegExp('\n','g'),'<br>').replace(new RegExp(' ','g'),'&nbsp;')%><%}else{%>無內容<%}%>
				</div>
				<div class="tab-pane" id="tab2">
					<table width="100%" height="275px">
						<tr>
							<td>
								<div class="myTitle">
									原始需要金額：
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=json.MoneyToBorrow.toFixed(0)%>元
								</div>	
							</td>
						</tr>
						<tr>
							<td>
								<div class="myTitle">
									已經借到金額：
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=json.Got.toFixed(0)%>元
								</div>	
							</td>
						</tr>
						<tr>
							<td>
								<div class="myTitle">
									還需要金額：
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=json.Need.toFixed(0)%>元
								</div>	
							</td>
						</tr>
						<tr>
							<td>
								<div class="myTitle">
									可接受年利率：
								</div>							
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=(json.MaxInterestRateAccepted*100).toFixed(2)%>%
								</div>		
							</td>
						</tr>
						<tr>
							<td>
								<div class="myTitle">
									可接受最低期數（單位/月）:
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=json.MonthPeriodAcceptedLowest.toFixed(0)%>個月
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div class="myTitle">
									可接受最高期數（單位/月）:
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=json.MonthPeriodAccepted.toFixed(0)%>個月
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div class="myTitle">
									希望於幾號前借到錢：
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=json.TimeLimit.getFullYear()%>/<%if(json.TimeLimit.getMonth()<9){%>0<%}%><%=json.TimeLimit.getMonth()+1%>/<%if(json.TimeLimit.getDate()<10){%>0<%}%><%=json.TimeLimit.getDate()%>
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div class="myTitle">
									信用等級：
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<div>
									&nbsp;&nbsp;&nbsp;&nbsp;<%=json.Level.toFixed(0)%>級
								</div>
							</td>
						</tr>
					</table>
				</div>
				<div class="tab-pane" id="tab3">
					<div class="my_discussion" id="discussionDiv">
						<%for(i=0;i<json.Discussion.length;i++){%>
							<span class="myTitle"><%=json.Discussion[i].CreatedBy.Username%>：</span>
							<br>
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%-json.Discussion[i].Content.replace(new RegExp('\n','g'),'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;').replace(new RegExp(' ','g'),'&nbsp;')%>
							<br>
							<table class="disFtrTable"><tr><td nowrap="nowrap"><span class="myTitle">No.<%=i+1%></span>&nbsp;&nbsp;&nbsp;</td><td><div class="myTitle">Created&nbsp;:&nbsp;<%=json.Discussion[i].Created.getFullYear()%>/<%if(json.Discussion[i].Created.getMonth()<9){%>0<%}%><%=json.Discussion[i].Created.getMonth()+1%>/<%if(json.Discussion[i].Created.getDate()<10){%>0<%}%><%=json.Discussion[i].Created.getDate()%></div><div class="myTitle">Updated:&nbsp;<%=json.Discussion[i].Updated.getFullYear()%>/<%if(json.Discussion[i].Updated.getMonth()<9){%>0<%}%><%=json.Discussion[i].Updated.getMonth()+1%>/<%if(json.Discussion[i].Updated.getDate()<10){%>0<%}%><%=json.Discussion[i].Updated.getDate()%></div></td></tr></table>
							<br>
						<%}%>
					</div>
					<div class="input-group my_discussion_ipt">
						<%if(userName===null){ %>
							<textarea style="height:35px;" placeholder="留言...Enter送出，Shift+Enter換行" class="form-control" onkeyup="value='';$('#myModal').modal('show');return false;"></textarea>
							<span class="input-group-btn">
								<button style="height:35px;" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
									<span class="glyphicon glyphicon-arrow-down myTitle2"></span>
								</button>
								<button style="height:35px;" class="btn btn-default" type="button" data-toggle="modal" data-target="#myModal">
									<span class="glyphicon glyphicon-comment myTitle2"></span>
								</button>
							</span>
						<% }else{ %>
							<textarea id="iptCtr" style="height:35px;" placeholder="留言...Enter送出，Shift+Enter換行" class="form-control" onkeypress="if(event.keyCode===13){if(!event.shiftKey){sendComment();return false;}}"></textarea>
							<span class="input-group-btn">
								<button style="height:35px;" onclick="newLineMain();" class="btn btn-default" type="button" id="newlButton">
									<span class="glyphicon glyphicon-arrow-down myTitle2"></span>
								</button>
								<button style="height:35px;" onclick="sendComment();" class="btn btn-default" type="button" id="sendButton">
									<span class="glyphicon glyphicon-comment myTitle2"></span>
								</button>
							</span>
						<%}%>
					</div>
				</div>
            </div>
			<br>
			<div class="resp">
				<table width="100%">
					<tr>
						<td nowrap="nowrap">
							<%if(userName===null){ %>
								<button class="btn btn-default" data-toggle="modal" data-target="#myModal">
									<span class="myTitle2">我想借錢給此人</span>
								</button>
							<% }else{ %>
								<%if(!ifSelf){ %>
									<%if(!jsonBorrowMessage){%>
										<%if(!jsonMessage){ %>
											<%if(!json.IfReadable){ %>
												<button type="button" class="btn btn-default disabled">
													<span class="myTitle2">該故事已封存</span>
												</button>
											<%}else{%>
												<button type="button" class="btn btn-default" onclick="openForm('#hendLendModal');">
													<span class="myTitle2">我想借錢給此人</span>
												</button>
											<%}%>
										<% }else{ %>
											<%if(!json.IfReadable){ %>
												<button type="button" class="btn btn-default" onclick="openForm('#hendLendModal');">
													<span class="myTitle2">該故事已封存，但您仍可查看訊息</span>
												</button>
											<%}else{%>
												<%if(jsonMessage.Status==='Confirmed'){ %>
													<button type="button" class="btn btn-default" onclick="openForm('#hendLendModal');">
														<span class="myTitle2">您的出借訊息已被同意</span>
													</button>
												<% }else if(jsonMessage.Status==='Rejected'){ %>
													<button type="button" class="btn btn-default" onclick="openForm('#hendLendModal');">
														<span class="myTitle2">您的出借訊息已被婉拒</span>
													</button>
												<% }else if(jsonMessage.Status==='NotConfirmed'){ %>
													<button type="button" class="btn btn-default" onclick="openForm('#hendLendModal');">
														<span class="myTitle2">我想更新出借訊息</span>
													</button>
												<%}%>
											<%}%>
										<%}%>
									<%}else{%>
										<%if(!json.IfReadable){ %>
											<button type="button" class="btn btn-default" onclick="openForm('#confirmModal');">
												<span class="myTitle2">該故事已封存，但您仍可查看訊息</span>
											</button>
										<%}else{%>
											<%if(jsonBorrowMessage.Status==='Confirmed'){ %>
												<button type="button" class="btn btn-default" onclick="openForm('#confirmModal');">
													<span class="myTitle2">您已同意來自此人的借款請求</span>
												</button>
											<% }else if(jsonBorrowMessage.Status==='Rejected'){ %>
												<button type="button" class="btn btn-default" onclick="openForm('#confirmModal');">
													<span class="myTitle2">您已婉拒來自此人的借款請求</span>
												</button>
											<% }else if(jsonBorrowMessage.Status==='NotConfirmed'){ %>
												<button type="button" class="btn btn-default" onclick="openForm('#confirmModal');">
													<span class="myTitle2">查看來自此人的訊息</span>
												</button>
											<%}%>
										<%}%>
									<%}%>
								<%}else{%>
									<%if(json.IfReadable){ %>
										<button type="button" class="btn btn-default"  data-toggle="modal" data-target="#readableModal">
											<span class="myTitle2">此故事為您所有，點擊可進行封存</span>
										</button>
									<%}else{%>
										<button type="button" class="btn btn-default disabled">
											<span class="myTitle2">此故事為您所有，且已經封存</span>
										</button>
									<%}%>
								<%}%>
							<%}%>
							&nbsp;&nbsp;&nbsp;&nbsp;
						</td>
						<td align="right">
							<div>
								Updated：<span id="updatedDate"><%=json.Updated.getFullYear()%>/<%if(json.Updated.getMonth()<9){%>0<%}%><%=json.Updated.getMonth()+1%>/<%if(json.Updated.getDate()<10){%>0<%}%><%=json.Updated.getDate()%></span>
							</div>
							<div>
								Created：<%=json.Created.getFullYear()%>/<%if(json.Created.getMonth()<9){%>0<%}%><%=json.Created.getMonth()+1%>/<%if(json.Created.getDate()<10){%>0<%}%><%=json.Created.getDate()%>
							</div>
						</td>
					</tr>
					<tr>
						<td align="center">
							&nbsp;&nbsp;&nbsp;&nbsp;<span><img width="65px" height="65px" src="/images/icon.png" class="hastip" title="喜歡這個故事的話可以<br>主動借款給他喔！"/></span>
						</td>
					</tr>
				</table>
			</div>
		</div>
		<div class="col-md-3">
		</div>
	</div>
</div>
<%if(userName!==null){ %>
	<%if(!ifSelf){ %>
		<div class="modal fade" id="msgModal">
			<div class="modal-dialog modal-sm">
				<div class="modal-content">
					<div class="modal-header" style="text-align: center;">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">錯誤</h4>
					</div>
					<div class="modal-body" style="text-align: center;">
						<br>
						必填欄位未填或已填欄位數值錯誤
						<br>
						<br>
					</div>
					<div class="modal-footer" style="text-align: center;">
						<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
					</div>
				</div>
			</div>
		</div>
		<%if(!jsonBorrowMessage){%>
			<%if(!jsonMessage){ %>
				<%if(json.IfReadable){ %>
					<div class="modal fade" id="hendLendModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-md">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title" id="myModalLabel">欲借出訊息 - 新建</h4>
								</div>
								<div class="modal-body">
									<h4>銀行帳戶內餘額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt0" type="text" class="form-control" readonly="readonly" value="<%=MoneyInBankAccountValue.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>目前最高可設定自動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt1" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.maxSettingAutoLend.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>最大可自動借出金額：<%if(jsonLend){%><span id="s0" class="red"></span><%}%></h4>
									<div class="input-group">
										<%if(jsonLend){%>
											<input id="lendChangerIpt" type="text" class="form-control" value="<%=jsonLend.MaxMoneyToLend.toFixed(0)%>" onkeypress="if(event.keyCode===13){lendChanger();}">
											<span class="input-group-addon">元</span>
										<%}else{%>
											<input type="text" class="form-control" readonly="readonly" value="未找到自動出借設定！">
											<span class="input-group-addon">#</span>
										<%}%>
									</div>
									<br>
									<%if(jsonLend){%>
										<button id="lendChangerBtn" type="button" class="btn btn-default" onclick="lendChanger();">變更</button>
										<br>
									<%}%>
									<h4>已借出總金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt2" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLendedCumulated.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>已手動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt3" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.hendLendCumulated.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>尚可手動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt4" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLeftToHendLend.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>已自動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt5" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.autoLendCumulated.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>尚可自動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt6" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLeftToAutoLend.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<div class="my-divider"></div>
								<form action="/Messages/toLendCreate" method="post" onsubmit="return disableButton();">
									<h4>本次欲借出金額：<i class="red">*</i><span id="s1" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[0]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[0]%><%}%><%}%></span></h4>
									<div class="input-group">
										<input id="f1" type="number" class="form-control" name="MoneyToLend" required="required"<%if(hlfJSON){%> value="<%=hlfJSON.FormContent.F1%>"<%}%>>
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>本次欲借出年利率：<i class="red">*</i><span id="s2" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[1]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[1]%><%}%><%}%></span></h4>
									<div class="input-group">	
										<input id="f2" type="text" class="form-control" name="InterestRate" required="required"<%if(hlfJSON){%> value="<%=hlfJSON.FormContent.F2%>"<%}%>>
										<span class="input-group-addon">%</span>
									</div>
									<br>
									<h4>本次欲借出期數（單位/月，最大36個月）：<i class="red">*</i><br><span id="s3" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[2]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[2]%><%}%><%}%></span></h4>
									<div class="input-group">
										<input id="f3" type="number" class="form-control" name="MonthPeriod" required="required"<%if(hlfJSON){%> value="<%=hlfJSON.FormContent.F3%>"<%}%>>
										<span class="input-group-addon">個月</span>
									</div>
									<br>
									<div class="my-divider"></div>
									<button type="button" class="btn btn-default" onclick="interestInFutureCalculator();">試算</button>
									<br>
									<h4>預計總利息：</h4>
									<div class="input-group">
										<input name="F5" type="text" class="form-control" id="interestFuture" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F5%><%}else{%>0<%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計本利和：</h4>
									<div class="input-group">
										<input name="F6" type="text" class="form-control" id="moneyFuture" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F6%><%}else{%>0<%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計每期平均利息：</h4>
									<div class="input-group">
										<input name="F7" type="text" class="form-control" id="interestFutureMonth" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F7%><%}else{%>0<%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計每期平均本利和：</h4>
									<div class="input-group">
										<input name="F8" type="text" class="form-control" id="interestFutureMoneyMonth" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F8%><%}else{%>0<%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計總利息/最初本金比：</h4>
									<div class="input-group">
										<input name="F9" type="text" class="form-control" id="interestFutureDivMoney" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F9%><%}else{%>0<%}%>">
										<span class="input-group-addon">%</span>
									</div>
									<br>
									<div class="my-divider"></div>
									<h4>訊息（選填）：<span id="s4" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[3]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[3]%><%}%><%}%></span></h4>
									<textarea class="form-control" name="Message" rows="3"><%if(hlfJSON){%><%=hlfJSON.FormContent.F4%><%}%></textarea>
								</div>
									<input type="hidden" name="FromBorrowRequest" value="<%=json._id%>">
									<div class="modal-footer">
										<div class="btn-toolbar" role="toolbar">
											<div class="btn-group" role="group">
												<button type="button" class="btn btn-info" onclick="checkAndOpenModal(chkModal1,mdlCnt1,'送出欲借出訊息嗎?',true);">
													新建
												</button>
											</div>
											<div class="btn-group" role="group">
												<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
											</div>
										</div>
									</div>
							</div>
						</div>
					</div>
					<div class="modal fade" id="chkModal1">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header" style="text-align: center;">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title">再次確認</h4>
								</div>
								<div id="mdlCnt1" class="modal-body" style="text-align: center;">
								</div>
								<div class="modal-footer" style="text-align: center;">
									<button type="submit" class="btn btn-primary" id="createBtnID" onclick="create()">確定</button>
									<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
								</div>
							</div>
						</div>
					</div>
					</form>
				<%}%>
			<%}else{%>
				<%if((!json.IfReadable)||(jsonMessage.Status==='Confirmed')||(jsonMessage.Status==='Rejected')){ %>
					<div class="modal fade" id="hendLendModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-md">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title" id="myModalLabel">欲借出訊息 - <%if(jsonMessage.Status==='Confirmed'){ %>已被同意<%}else if(jsonMessage.Status==='NotConfirmed'){%>未被確認<%}else if(jsonMessage.Status==='Rejected'){%>已被婉拒<%}%></h4>
								</div>
								<div class="modal-body">
									<h4>本次欲借出金額：</h4>
									<div class="input-group">
										<input type="number" class="form-control" name="MoneyToLend" readonly="readonly" value="<%=jsonMessage.MoneyToLend.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>本次欲借出年利率：</h4>
									<div class="input-group">
										<input type="text" class="form-control" name="InterestRate" readonly="readonly" value="<%=(jsonMessage.InterestRate*100).toFixed(2)%>">
										<span class="input-group-addon">%</span>
									</div>
									<br>
									<h4>本次欲借出期數（單位/月）：</h4>
									<div class="input-group">
										<input type="number" class="form-control" name="MonthPeriod" readonly="readonly" value="<%=jsonMessage.MonthPeriod.toFixed(0)%>">
										<span class="input-group-addon">個月</span>
									</div>
									<br>
									<div class="my-divider"></div>
									<h4>預計總利息：</h4>
									<div class="input-group">
										<input type="text" class="form-control" id="interestFuture" readonly="readonly" value="<%=jsonMessage.InterestInFuture.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計本利和：</h4>
									<div class="input-group">
										<input type="text" class="form-control" id="moneyFuture" readonly="readonly" value="<%=jsonMessage.MoneyFuture.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計每期平均利息：</h4>
									<div class="input-group">
										<input type="text" class="form-control" id="interestFutureMonth" readonly="readonly" value="<%=jsonMessage.InterestInFutureMonth.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計每期平均本利和：</h4>
									<div class="input-group">
										<input type="text" class="form-control" id="interestFutureMoneyMonth" readonly="readonly" value="<%=jsonMessage.InterestInFutureMoneyMonth.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計總利息/最初本金比：</h4>
									<div class="input-group">
										<input type="text" class="form-control" id="interestFutureDivMoney" readonly="readonly" value="<%=jsonMessage.InterestInFutureDivMoney.toFixed(2)%>">
										<span class="input-group-addon">%</span>
									</div>
									<br>
									<div class="my-divider"></div>
									<h4>訊息：</h4>
									<textarea class="form-control" name="Message" rows="3" readonly="readonly"><%if(jsonMessage.Message!==''){%><%=jsonMessage.Message.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&')%><%}else{%>無內容<%}%></textarea>
									<br>
								</div>
								<%if(jsonMessage.Status==='NotConfirmed'){%>
									<form action="/Messages/destroy" method="post" onsubmit="return disableButton();">
									<input type="hidden" name="FromBorrowRequest" value="<%=json._id%>">
									<input type="hidden" name="_id" value="<%=jsonMessage._id%>">
								<%}%>
								<div class="modal-footer" style="text-align: left;">
									<%if(jsonMessage.Status==='NotConfirmed'){%>
										<button type="button" class="btn btn-danger" onclick="checkAndOpenModal(chkModal7,mdlCnt7,'您確定要刪除欲借出訊息嗎?',false);">
											刪除
										</button>
										&nbsp;
									<%}%>
									<a href="/lender/lenderSendMessages?msgKeyword=<%=jsonMessage._id%>&filter=<%if(jsonMessage.Status==="NotConfirmed"){%><%=encodeURIComponent('未被確認')%><%}else if(jsonMessage.Status==="Confirmed"){%><%=encodeURIComponent('已被同意')%><%}else if(jsonMessage.Status==="Rejected"){%><%=encodeURIComponent('已被婉拒')%><%}%>&classor=<%=encodeURIComponent("不分故事種類");%>&sorter=<%=encodeURIComponent("更新日期")%>&director=<%=encodeURIComponent("大至小");%>&lbound=&ubound=&page=1">
										<button type="button" class="btn btn-default">查看</button>
									</a>
									&nbsp;
									<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
								</div>
							</div>
						</div>
					</div>
					<%if(jsonMessage.Status==='NotConfirmed'){%>
					<div class="modal fade" id="chkModal7">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header" style="text-align: center;">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title">再次確認</h4>
								</div>
								<div id="mdlCnt7" class="modal-body" style="text-align: center;">
								</div>
								<div class="modal-footer" style="text-align: center;">
									<button type="submit" class="btn btn-danger" id="destroyBtnID" onclick="destroy();">確定</button>
									<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
								</div>
							</div>
						</div>
					</div>
					</form>
					<%}%>
				<%}else{%>
					<div class="modal fade" id="hendLendModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
						<div class="modal-dialog modal-md">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title" id="myModalLabel">欲借出訊息 - 更新/刪除</h4>
								</div>
								<div class="modal-body">
									<h4>銀行帳戶內餘額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt0" type="text" class="form-control" readonly="readonly" value="<%=MoneyInBankAccountValue.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>目前最高可設定自動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt1" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.maxSettingAutoLend.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>最大可自動借出金額：<%if(jsonLend){%><span id="s0" class="red"></span><%}%></h4>
									<div class="input-group">
										<%if(jsonLend){%>
											<input id="lendChangerIpt" type="text" class="form-control" value="<%=jsonLend.MaxMoneyToLend.toFixed(0)%>" onkeypress="if(event.keyCode===13){lendChanger();}">
											<span class="input-group-addon">元</span>
										<%}else{%>
											<input type="text" class="form-control" readonly="readonly" value="未找到自動出借設定！">
											<span class="input-group-addon">#</span>
										<%}%>
									</div>
									<br>
									<%if(jsonLend){%>
										<button id="lendChangerBtn" type="button" class="btn btn-default" onclick="lendChanger();">變更</button>
										<br>
									<%}%>
									<h4>已借出總金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt2" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLendedCumulated.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>已手動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt3" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.hendLendCumulated.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>尚可手動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt4" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLeftToHendLend.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>已自動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt5" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.autoLendCumulated.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>尚可自動借出金額：</h4>
									<div class="input-group">
										<input id="lendChangerIpt6" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLeftToAutoLend.toFixed(0)%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<div class="my-divider"></div>
								<form action="/Messages/toLendUpdate" method="post" id="formID" onsubmit="return disableButton();">
									<h4>本次欲借出金額：<i class="red">*</i><span id="s1" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[0]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[0]%><%}%><%}%></span></h4>
									<div class="input-group">
										<input id="f1" type="number" class="form-control" name="MoneyToLend" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F1%><%}else{%><%=jsonMessage.MoneyToLend.toFixed(0)%><%}%>" required="required">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>本次欲借出年利率：<i class="red">*</i><span id="s2" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[1]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[1]%><%}%><%}%></span></h4>
									<div class="input-group">
										<input id="f2" type="text" class="form-control" name="InterestRate" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F2%><%}else{%><%=(jsonMessage.InterestRate*100).toFixed(2)%><%}%>" required="required">
										<span class="input-group-addon">%</span>
									</div>
									<br>
									<h4>本次欲借出期數（單位/月，最大36個月）：<i class="red">*</i><br><span id="s3" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[2]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[2]%><%}%><%}%></span></h4>
									<div class="input-group">
										<input id="f3" type="number" class="form-control" name="MonthPeriod" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F3%><%}else{%><%=jsonMessage.MonthPeriod.toFixed(0)%><%}%>" required="required">
										<span class="input-group-addon">個月</span>
									</div>
									<br>
									<div class="my-divider"></div>
									<button type="button" class="btn btn-default" onclick="interestInFutureCalculator();">重新試算</button>
									<br>
									<h4>預計總利息：</h4>
									<div class="input-group">
										<input name="F5" type="text" class="form-control" id="interestFuture" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F5%><%}else{%><%=jsonMessage.InterestInFuture.toFixed(0)%><%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計本利和：</h4>
									<div class="input-group">
										<input name="F6" type="text" class="form-control" id="moneyFuture" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F6%><%}else{%><%=jsonMessage.MoneyFuture.toFixed(0)%><%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計每期平均利息：</h4>
									<div class="input-group">
										<input name="F7" type="text" class="form-control" id="interestFutureMonth" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F7%><%}else{%><%=jsonMessage.InterestInFutureMonth.toFixed(0)%><%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計每期平均本利和：</h4>
									<div class="input-group">
										<input name="F8" type="text" class="form-control" id="interestFutureMoneyMonth" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F8%><%}else{%><%=jsonMessage.InterestInFutureMoneyMonth.toFixed(0)%><%}%>">
										<span class="input-group-addon">元</span>
									</div>
									<br>
									<h4>預計總利息/最初本金比：</h4>
									<div class="input-group">
										<input name="F9" type="text" class="form-control" id="interestFutureDivMoney" readonly="readonly" value="<%if(hlfJSON){%><%=hlfJSON.FormContent.F9%><%}else{%><%=jsonMessage.InterestInFutureDivMoney.toFixed(2)%><%}%>">
										<span class="input-group-addon">%</span>
									</div>
									<br>
									<div class="my-divider"></div>
									<h4>訊息（選填）：<span id="s4" class="red"><%if(hlfJSON){%><%if(hlfJSON.Target[3]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=hlfJSON.Message[3]%><%}%><%}%></span></h4>
									<textarea class="form-control" name="Message" rows="3"><%if(hlfJSON){%><%=hlfJSON.FormContent.F4%><%}else{%><%=jsonMessage.Message.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&')%><%}%></textarea>
								</div>
								<input type="hidden" name="FromBorrowRequest" value="<%=json._id%>">
								<input type="hidden" name="_id" value="<%=jsonMessage._id%>">
								<div class="modal-footer">
									<div style="float:left;" class="btn-toolbar" role="toolbar">
										<div class="btn-group" role="group">
											<button type="button" class="btn btn-info" onclick="checkAndOpenModal(chkModal2,mdlCnt2,'更新欲借出訊息嗎?',true);">
												更新
											</button>
										</div>
										<div class="btn-group" role="group">
											<button type="button" class="btn btn-danger" onclick="checkAndOpenModal(chkModal3,mdlCnt3,'您確定要刪除欲借出訊息嗎?',false);">
												刪除
											</button>
										</div>
									</div>
									<div style="float:right;">
										<a href="/lender/lenderSendMessages?msgKeyword=<%=jsonMessage._id%>&filter=<%if(jsonMessage.Status==="NotConfirmed"){%><%=encodeURIComponent('未被確認')%><%}else if(jsonMessage.Status==="Confirmed"){%><%=encodeURIComponent('已被同意')%><%}else if(jsonMessage.Status==="Rejected"){%><%=encodeURIComponent('已被婉拒')%><%}%>&classor=<%=encodeURIComponent("不分故事種類");%>&sorter=<%=encodeURIComponent("更新日期")%>&director=<%=encodeURIComponent("大至小");%>&lbound=&ubound=&page=1">
											<button type="button" class="btn btn-default">查看</button>
										</a>
										<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="modal fade" id="chkModal2">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header" style="text-align: center;">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title">再次確認</h4>
								</div>
								<div id="mdlCnt2" class="modal-body" style="text-align: center;">
								</div>
								<div class="modal-footer" style="text-align: center;">
									<button type="submit" class="btn btn-primary" id="updateBtnID" onclick="update()">確定</button>
									<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
								</div>
							</div>
						</div>
					</div>
					<div class="modal fade" id="chkModal3">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header" style="text-align: center;">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title">再次確認</h4>
								</div>
								<div id="mdlCnt3" class="modal-body" style="text-align: center;">
								</div>
								<div class="modal-footer" style="text-align: center;">
									<button type="button" class="btn btn-danger" id="destroyBtnID" onclick="destroy();">確定</button>
									<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
								</div>
							</div>
						</div>
					</div>
					</form>					
				<%}%>
			<%}%>
		<%}else{%>
			<%if((!json.IfReadable)||(jsonBorrowMessage.Status==='Confirmed')||(jsonBorrowMessage.Status==='Rejected')){ %>
				<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-md">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
								<h4 class="modal-title" id="myModalLabel">借款請求 - <%if(jsonBorrowMessage.Status==='Confirmed'){ %>已同意<%}else if(jsonBorrowMessage.Status==='NotConfirmed'){%>未確認<%}else if(jsonBorrowMessage.Status==='Rejected'){%>已婉拒<%}%></h4>
							</div>
							<div class="modal-body">
								<h4>金額：</h4>
								<div class="input-group">
									<input type="number" class="form-control" name="MoneyToLend" readonly="readonly" value="<%=jsonBorrowMessage.MoneyToLend.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>年利率：</h4>
								<div class="input-group">
									<input type="text" class="form-control" name="InterestRate" readonly="readonly" value="<%=(jsonBorrowMessage.InterestRate*100).toFixed(2)%>">
									<span class="input-group-addon">%</span>
								</div>
								<br>
								<h4>期數（單位/月）：</h4>
								<div class="input-group">
									<input type="number" class="form-control" name="MonthPeriod" readonly="readonly" value="<%=jsonBorrowMessage.MonthPeriod.toFixed(0)%>">
									<span class="input-group-addon">個月</span>
								</div>
								<br>
								<div class="my-divider"></div>
								<h4>預計總利息：</h4>
								<div class="input-group">
									<input type="text" class="form-control" id="interestFuture" readonly="readonly" value="<%=jsonBorrowMessage.InterestInFuture.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計本利和：</h4>
								<div class="input-group">
									<input type="text" class="form-control" id="moneyFuture" readonly="readonly" value="<%=jsonBorrowMessage.MoneyFuture.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計每期平均利息：</h4>
								<div class="input-group">
									<input type="text" class="form-control" id="interestFutureMonth" readonly="readonly" value="<%=jsonBorrowMessage.InterestInFutureMonth.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計每期平均本利和：</h4>
								<div class="input-group">
									<input type="text" class="form-control" id="interestFutureMoneyMonth" readonly="readonly" value="<%=jsonBorrowMessage.InterestInFutureMoneyMonth.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計總利息/最初本金比：</h4>
								<div class="input-group">
									<input type="text" class="form-control" id="interestFutureDivMoney" readonly="readonly" value="<%=jsonBorrowMessage.InterestInFutureDivMoney.toFixed(2)%>">
									<span class="input-group-addon">%</span>
								</div>
								<br>
								<div class="my-divider"></div>
								<h4>訊息：</h4>
								<textarea class="form-control" name="Message" rows="3" readonly="readonly"><%if(jsonBorrowMessage.Message!==''){%><%=jsonBorrowMessage.Message.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&')%><%}else{%>無內容<%}%></textarea>
								<br>
							</div>
							<%if(jsonBorrowMessage.Status==='NotConfirmed'){%>
							<form action="/Messages/rejectToBorrowMessageInStory" method="post" onsubmit="return disableButton();">
							<input type="hidden" name="FromBorrowRequest" value="<%=json._id%>">
							<input type="hidden" name="MessageID" value="<%=jsonBorrowMessage._id%>">
							<%}%>
							<div class="modal-footer" style="text-align: left;">
								<%if(jsonBorrowMessage.Status==='NotConfirmed'){%>
									<button type="button" class="btn btn-danger" onclick="checkAndOpenModal(chkModal6,mdlCnt6,'您確定要婉拒此借款請求嗎?',false);">
										婉拒
									</button>
									&nbsp;
								<%}%>
								<a href="/lender/lenderReceiveMessages?msgKeyword=<%=jsonBorrowMessage._id%>&filter=<%if(jsonBorrowMessage.Status==="NotConfirmed"){%><%=encodeURIComponent('未確認')%><%}else if(jsonBorrowMessage.Status==="Confirmed"){%><%=encodeURIComponent('已同意')%><%}else if(jsonBorrowMessage.Status==="Rejected"){%><%=encodeURIComponent('已婉拒')%><%}%>&classor=<%=encodeURIComponent("不分故事種類");%>&sorter=<%=encodeURIComponent("更新日期")%>&director=<%=encodeURIComponent("大至小");%>&lbound=&ubound=&page=1">
									<button type="button" class="btn btn-default">查看</button>
								</a>
								&nbsp;
								<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
							</div>
						</div>
					</div>
				</div>
				<%if(jsonBorrowMessage.Status==='NotConfirmed'){%>
				<div class="modal fade" id="chkModal6">
					<div class="modal-dialog modal-sm">
						<div class="modal-content">
							<div class="modal-header" style="text-align: center;">
								<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
								<h4 class="modal-title">再次確認</h4>
							</div>
							<div id="mdlCnt6" class="modal-body" style="text-align: center;">
							</div>
							<div class="modal-footer" style="text-align: center;">
								<button type="submit" class="btn btn-danger" onclick="refuse();" id="rfsBtnID">確定</button>
								<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
							</div>
						</div>
					</div>
				</div>
				</form>
				<%}%>
			<%}else{%>
				<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-md">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
								<h4 class="modal-title" id="myModalLabel">回覆借款請求</h4>
							</div>
							<div class="modal-body">
								<h4>銀行帳戶內餘額：</h4>
								<div class="input-group">
									<input id="lendChangerIpt0" type="text" class="form-control" readonly="readonly" value="<%=MoneyInBankAccountValue.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>目前最高可設定自動借出金額：</h4>
								<div class="input-group">
									<input id="lendChangerIpt1" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.maxSettingAutoLend.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>最大可自動借出金額：<%if(jsonLend){%><span id="s0" class="red"></span><%}%></h4>
								<div class="input-group">
									<%if(jsonLend){%>
										<input id="lendChangerIpt" type="text" class="form-control" value="<%=jsonLend.MaxMoneyToLend.toFixed(0)%>" onkeypress="if(event.keyCode===13){lendChanger();}">
										<span class="input-group-addon">元</span>
									<%}else{%>
										<input type="text" class="form-control" readonly="readonly" value="未找到自動出借設定！">
										<span class="input-group-addon">#</span>
									<%}%>
								</div>
								<br>
								<%if(jsonLend){%>
									<button id="lendChangerBtn" type="button" class="btn btn-default" onclick="lendChanger();">變更</button>
									<br>
								<%}%>
								<h4>已借出總金額：</h4>
								<div class="input-group">
									<input id="lendChangerIpt2" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLendedCumulated.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>已手動借出金額：</h4>
								<div class="input-group">
									<input id="lendChangerIpt3" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.hendLendCumulated.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>尚可手動借出金額：</h4>
								<div class="input-group">
									<input id="lendChangerIpt4" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLeftToHendLend.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>已自動借出金額：</h4>
								<div class="input-group">
									<input id="lendChangerIpt5" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.autoLendCumulated.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>尚可自動借出金額：</h4>
								<div class="input-group">
									<input id="lendChangerIpt6" type="text" class="form-control" readonly="readonly" value="<%=MoneyLended.moneyLeftToAutoLend.toFixed(0)%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<div class="my-divider"></div>
							<form action="/Messages/confirmToBorrowMessageInStory" method="post" id="confirmFormID" onsubmit="return disableButton(1);">
								<h4>金額：<i class="red">*</i><span id="s1" class="red"><%if(cfJSON){%><%if(cfJSON.Target[0]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=cfJSON.Message[0]%><%}%><%}%></span></h4>
								<div class="input-group">
									<input id="f1" type="number" class="form-control" name="MoneyToLend" value="<%if(cfJSON){%><%=cfJSON.FormContent.F1%><%}else{%><%=jsonBorrowMessage.MoneyToLend.toFixed(0)%><%}%>" required="required">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>年利率：<i class="red">*</i><span id="s2" class="red"><%if(cfJSON){%><%if(cfJSON.Target[1]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=cfJSON.Message[1]%><%}%><%}%></span></h4>
								<div class="input-group">
									<input id="f2" type="text" class="form-control" name="InterestRate" value="<%if(cfJSON){%><%=cfJSON.FormContent.F2%><%}else{%><%=(jsonBorrowMessage.InterestRate*100).toFixed(2)%><%}%>" required="required">
									<span class="input-group-addon">%</span>
								</div>
								<br>
								<h4>期數（單位/月，最大36個月）：<i class="red">*</i><br><span id="s3" class="red"><%if(cfJSON){%><%if(cfJSON.Target[2]){%>&nbsp;&nbsp;&nbsp;&nbsp;<%=cfJSON.Message[2]%><%}%><%}%></span></h4>
								<div class="input-group">
									<input id="f3" type="number" class="form-control" name="MonthPeriod" value="<%if(cfJSON){%><%=cfJSON.FormContent.F3%><%}else{%><%=jsonBorrowMessage.MonthPeriod.toFixed(0)%><%}%>" required="required">
									<span class="input-group-addon">個月</span>
								</div>
								<br>
								<div class="my-divider"></div>
								<button type="button" class="btn btn-default" onclick="interestInFutureCalculator();">重新試算</button>
								<br>
								<h4>預計總利息：</h4>
								<div class="input-group">
									<input name="F5" type="text" class="form-control" id="interestFuture" readonly="readonly" value="<%if(cfJSON){%><%=cfJSON.FormContent.F5%><%}else{%><%=jsonBorrowMessage.InterestInFuture.toFixed(0)%><%}%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計本利和：</h4>
								<div class="input-group">
									<input name="F6" type="text" class="form-control" id="moneyFuture" readonly="readonly" value="<%if(cfJSON){%><%=cfJSON.FormContent.F6%><%}else{%><%=jsonBorrowMessage.MoneyFuture.toFixed(0)%><%}%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計每期平均利息：</h4>
								<div class="input-group">
									<input name="F7" type="text" class="form-control" id="interestFutureMonth" readonly="readonly" value="<%if(cfJSON){%><%=cfJSON.FormContent.F7%><%}else{%><%=jsonBorrowMessage.InterestInFutureMonth.toFixed(0)%><%}%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計每期平均本利和：</h4>
								<div class="input-group">
									<input name="F8" type="text" class="form-control" id="interestFutureMoneyMonth" readonly="readonly" value="<%if(cfJSON){%><%=cfJSON.FormContent.F8%><%}else{%><%=jsonBorrowMessage.InterestInFutureMoneyMonth.toFixed(0)%><%}%>">
									<span class="input-group-addon">元</span>
								</div>
								<br>
								<h4>預計總利息/最初本金比：</h4>
								<div class="input-group">
									<input name="F9" type="text" class="form-control" id="interestFutureDivMoney" readonly="readonly" value="<%if(cfJSON){%><%=cfJSON.FormContent.F9%><%}else{%><%=jsonBorrowMessage.InterestInFutureDivMoney.toFixed(2)%><%}%>">
									<span class="input-group-addon">%</span>
								</div>
								<br>
								<div class="my-divider"></div>
								<h4>訊息：</h4>
								<textarea class="form-control" name="Message" rows="3" readonly="readonly"><%if(cfJSON){%><%=cfJSON.FormContent.F4%><%}else{%><%if(jsonBorrowMessage.Message!==''){%><%=jsonBorrowMessage.Message.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&')%><%}else{%>無內容<%}%><%}%></textarea>
							</div>
							<input type="hidden" name="FromBorrowRequest" value="<%=json._id%>">
							<input type="hidden" name="MessageID" value="<%=jsonBorrowMessage._id%>">
							<div class="modal-footer">
								<div style="float:left;" class="btn-toolbar" role="toolbar">
									<div class="btn-group" role="group">
										<%if(jsonLend){%>
											<button type="button" class="btn btn-info" onclick="checkAndOpenModal(chkModal4,mdlCnt4,'同意此借款請求嗎?',true);">同意</button>
										<%}else{%>
											<button type="button" class="btn btn-info" data-toggle="modal" data-target="#chkModal4">同意</button>
										<%}%>
									</div>
									<div class="btn-group" role="group">
										<button type="button" class="btn btn-danger" onclick="checkAndOpenModal(chkModal5,mdlCnt5,'您確定要婉拒此借款請求嗎?',false);">
											婉拒
										</button>
									</div>
								</div>
								<div style="float:right;">
									<a href="/lender/lenderReceiveMessages?msgKeyword=<%=jsonBorrowMessage._id%>&filter=<%if(jsonBorrowMessage.Status==="NotConfirmed"){%><%=encodeURIComponent('未確認')%><%}else if(jsonBorrowMessage.Status==="Confirmed"){%><%=encodeURIComponent('已同意')%><%}else if(jsonBorrowMessage.Status==="Rejected"){%><%=encodeURIComponent('已婉拒')%><%}%>&classor=<%=encodeURIComponent("不分故事種類");%>&sorter=<%=encodeURIComponent("更新日期")%>&director=<%=encodeURIComponent("大至小");%>&lbound=&ubound=&page=1">
										<button type="button" class="btn btn-default">查看</button>
									</a>
									<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<%if(jsonLend){%>
					<div class="modal fade" id="chkModal4">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header" style="text-align: center;">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title">再次確認</h4>
								</div>
								<div id="mdlCnt4" class="modal-body" style="text-align: center;">
								</div>
								<div class="modal-footer" style="text-align: center;">
									<button type="submit" class="btn btn-primary"  onclick="agree();" id="argBtnID">確定</button>
									<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
								</div>
							</div>
						</div>
					</div>
				<%}else{%>
					<div class="modal fade" id="chkModal4">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header" style="text-align: center;">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title">錯誤</h4>
								</div>
								<div class="modal-body" style="text-align: center;">
									未找到自動出借設定！
								</div>
								<div class="modal-footer" style="text-align: center;">
									<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
								</div>
							</div>
						</div>
					</div>
				<%}%>
				<div class="modal fade" id="chkModal5">
					<div class="modal-dialog modal-sm">
						<div class="modal-content">
							<div class="modal-header" style="text-align: center;">
								<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
								<h4 class="modal-title">再次確認</h4>
							</div>
							<div id="mdlCnt5" class="modal-body" style="text-align: center;">
							</div>
							<div class="modal-footer" style="text-align: center;">
								<button type="button" class="btn btn-danger" onclick="refuse();" id="rfsBtnID">確定</button>
								<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
							</div>
						</div>
					</div>
				</div>
				</form>
			<%}%>
		<%}%>
	<%}else{%>
		<%if(json.IfReadable){%>
			<div class="modal fade" id="readableModal">
				<div class="modal-dialog modal-sm">
					<div class="modal-content">
						<div class="modal-header" style="text-align: center;">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title">再次確認</h4>
						</div>
						<div class="modal-body" style="text-align: center;">
							<br>
							您確定要封存此借款故事？
							<br>
							<br>
						</div>
						<div class="modal-footer" style="text-align: center;">
						<form action="/Borrows/readable" method="post" onsubmit="return disableButton();">
							<input type="hidden" name="borrowID" value="<%=json._id%>">
							<button type="submit" class="btn btn-danger" onclick="readable();" id="readableBtnID">確定</button>
							<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						</form>
						</div>
					</div>
				</div>
			</div>
		<%}%>
	<%}%>
<%}%>			
<script>
	<%if(userName!==null){%>
		$(document).ready(function (){
			$('.modal')
				.on({
					'show.bs.modal': function() {
						var idx = $('.modal:visible').length;
						$(this).css('z-index', 1040 + (10 * idx));
					},
					'shown.bs.modal': function() {
						var idx = ($('.modal:visible').length) - 1; // raise backdrop after animation.
						$('.modal-backdrop').not('.stacked')
						.css('z-index', 1039 + (10 * idx))
						.addClass('stacked');
					},
					'hidden.bs.modal': function() {
						if ($('.modal:visible').length > 0) {
							// restore the modal-open class to the body element, so that scrolling works
							// properly after de-stacking a modal.
							setTimeout(function() {
								$(document.body).addClass('modal-open');
							}, 0);
						}
					}
				});
				
				<%if(hlfJSON){%>
					$('#myTab a[href="#tab2"]').tab('show');
					$('#hendLendModal').on('shown.bs.modal.myevent', function () {
						setTimeout(function() {
							<%for(i=0;i<hlfJSON.Target.length;i++){%>
								<%if(hlfJSON.Target[i]){%>
									$('#f<%=i+1%>').focus();
									<%break;%>
								<%}%>
							<%}%>
							$('#hendLendModal').off('shown.bs.modal.myevent');
						}, 100);
					});
					$('#hendLendModal').modal('show');
				<%}%>
				
				<%if(cfJSON){%>
					$('#myTab a[href="#tab2"]').tab('show');
					$('#confirmModal').on('shown.bs.modal.myevent', function () {
						setTimeout(function() {
							<%for(i=0;i<cfJSON.Target.length;i++){%>
								<%if(cfJSON.Target[i]){%>
									$('#f<%=i+1%>').focus();
									<%break;%>
								<%}%>
							<%}%>
							$('#confirmModal').off('shown.bs.modal.myevent');
						}, 100);
					});
					$('#confirmModal').modal('show');
				<%}%>
				
				$('#btnID').addClass('disabled');
				$.ajax({ 
					url: '/Borrows/iflike',
					type: 'POST',
					data:{_id:"<%=json._id%>"},
					dataType: 'json',
					success: function(Jdata) {
						if(Jdata.success){
							var dateObj=new Date(Jdata.date);
							var zeroMonth='';
							if(dateObj.getMonth()<9){
								zeroMonth='0';
							}
							var zeroDate='';
							if(dateObj.getDate()<10){
								zeroDate='0';
							}
							$('#updatedDate').html(dateObj.getFullYear()+'/'+zeroMonth+(dateObj.getMonth()+1)+'/'+zeroDate+dateObj.getDate());
							if(Jdata.status===-1){
								$('#likeBtn').html('<button class="btn btn-default" data-toggle="modal" data-target="#myModal" id="btnID"><span class="glyphicon glyphicon-thumbs-up myTitle2"></span></button>');	
							}else if(Jdata.status===0){
								$('#likeBtn').html('<button class="btn btn-default" onclick="like();" id="btnID"><span class="glyphicon glyphicon-thumbs-up myTitle2"></span></button>');	
							}else if(Jdata.status===1){
								$('#likeBtn').html('<button class="btn btn-default" onclick="unlike();" id="btnID"><span class="glyphicon glyphicon-remove myTitle2"></span></button>');	
							}else if(Jdata.status===2){
								$('#likeBtn').html('<button class="btn btn-default disabled" id="btnID"><span class="glyphicon glyphicon-thumbs-up myTitle2"></span></button>');	
							}
							$('#likeNum').html('&nbsp;'+Jdata.result);
						}else{
						}
					},
					error: function() {
					}
				});	
				
				startRenderComments();
				$.ajax({ 
					url: '/Discussions/findDiscussions',
					type: 'POST',
					data:{_id:"<%=json._id%>"},
					dataType: 'json',
					success: function(Jdata) {
						if(Jdata.success){
							renderComments(Jdata);
						}else{
							alert(Jdata.error);
						}
						$('#iptCtr').val('');
						endRenderComments();
					},
					error: function() {
						alert('something wrong.');
						$('#iptCtr').val('');
						endRenderComments();
					}
				});	
				
		});
		
		function openForm(target){
			$('#myTab a[href="#tab2"]').tab('show');
			$(target).modal('show');
		}
		
		function startRenderComments(){
			dcFlag=true;
			ecFlag=true;
			scFlag=true;
			$('#iptCtr').attr('onkeypress','');
			$('#iptCtr').attr('readonly','readonly');
			$('#sendButton').addClass('disabled');
			$('#newlButton').addClass('disabled');
			$(".actionTa").each(function() {
				$(this).attr('readonly','readonly');
			});
			$(".actionLi").each(function() {
				$(this).addClass('disabled');
			});
			$(".newBtnNel").each(function() {
				$(this).addClass('disabled');
			});
			$(".newBtnCom").each(function() {
				$(this).addClass('disabled');
			});
			$(".newBtnRev").each(function() {
				$(this).addClass('disabled');
			});
		}
		
		function renderComments(Jdata){
			var dateObj=new Date(Jdata.date);
			var zeroMonth='';
			if(dateObj.getMonth()<9){
				zeroMonth='0';
			}
			var zeroDate='';
			if(dateObj.getDate()<10){
				zeroDate='0';
			}
			$('#updatedDate').html(dateObj.getFullYear()+'/'+zeroMonth+(dateObj.getMonth()+1)+'/'+zeroDate+dateObj.getDate());
			$('#discussionDiv').html('');
			for(i=0;i<Jdata.result.length;i++){
				var dateObj2=new Date(Jdata.result[i].Created);
				var zeroMonth2_1='';
				if(dateObj2.getMonth()<9){
					zeroMonth2_1='0';
				}
				var zeroDate2_1='';
				if(dateObj2.getDate()<10){
					zeroDate2_1='0';
				}
				var year=dateObj2.getFullYear();
				var month=dateObj2.getMonth()+1;
				var date=dateObj2.getDate();
				
				dateObj2=new Date(Jdata.result[i].Updated);
				var zeroMonth2_2='';
				if(dateObj2.getMonth()<9){
					zeroMonth2_2='0';
				}
				var zeroDate2_2='';
				if(dateObj2.getDate()<10){
					zeroDate2_2='0';
				}
				var year2=dateObj2.getFullYear();
				var month2=dateObj2.getMonth()+1;
				var date2=dateObj2.getDate();
				
				if(!Jdata.CreatedByViewer[i]){
					$('#discussionDiv').append('<span class="myTitle">'+Jdata.result[i].CreatedBy.Username+'：</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+Jdata.result[i].Content.replace(/"/g,'&quot;').replace(new RegExp('\n','g'),'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;').replace(new RegExp(' ','g'),'&nbsp;')+'<br><table class="disFtrTable"><tr><td nowrap="nowrap"><span class="myTitle">No.'+(i+1)+'</span>&nbsp;&nbsp;&nbsp;</td><td><div class="myTitle">Created&nbsp;:&nbsp;'+year+'/'+zeroMonth2_1+month+'/'+zeroDate2_1+date+'</div><div class="myTitle">Updated:&nbsp;'+year2+'/'+zeroMonth2_2+month2+'/'+zeroDate2_2+date2+'</div></td></tr></table><br>');
				}else{
					$('#discussionDiv').append('<span class="myTitle">'+Jdata.result[i].CreatedBy.Username+'：</span><table width="95%"><tr><td><div style="display:inline;" id="cntIptDiv'+i+'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+Jdata.result[i].Content.replace(/"/g,'&quot;').replace(new RegExp('\n','g'),'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;').replace(new RegExp(' ','g'),'&nbsp;')+'</div><td nowrap="nowrap" align="right">&nbsp;&nbsp;&nbsp;&nbsp;<div class="btn-group"><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-pencil myTitle2"></span> <span class="caret myTitle2"></span></button><ul style="width:75px;min-width:75px;" class="dropdown-menu" role="menu"><li class="actionLi"><a href="#" onclick="startEdit('+i+');return false;">編輯</a></li><li class="actionLi"><a href="#" onclick="deleteComment('+i+');return false;">刪除</a></li></ul></div></td></tr></table><table class="disFtrTable"><tr><td nowrap="nowrap"><span class="myTitle">No.'+(i+1)+'</span>&nbsp;&nbsp;&nbsp;</td><td><div class="myTitle">Created&nbsp;:&nbsp;'+year+'/'+zeroMonth2_1+month+'/'+zeroDate2_1+date+'</div><div id="uptDate'+i+'" class="myTitle">Updated:&nbsp;'+year2+'/'+zeroMonth2_2+month2+'/'+zeroDate2_2+date2+'</div></td></tr></table></td><input type="hidden" id="hdIpt'+i+'" value="'+Jdata.result[i]._id+'"><input type="hidden" id="hdIpt2'+i+'" value="'+Jdata.result[i].Content.replace(/"/g,'&quot;')+'"><input type="hidden" id="hdIpt3'+i+'" value="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+Jdata.result[i].Content.replace(/"/g,'&quot;').replace(new RegExp('\n','g'),'<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;').replace(new RegExp(' ','g'),'&nbsp;')+'"><br>');
				}	
			}
		}
		
		function endRenderComments(){
			dcFlag=false;
			ecFlag=false;
			scFlag=false;
			$('#iptCtr').attr('onkeypress','if(event.keyCode===13){if(!event.shiftKey){sendComment();return false;}}');
			$('#iptCtr').removeAttr("readonly");
			$('#sendButton').removeClass('disabled');
			$('#newlButton').removeClass('disabled');
			$(".actionTa").each(function() {
				$(this).removeAttr("readonly");
			});
			$(".actionLi").each(function() {
				$(this).removeClass('disabled');
			});
			$(".newBtnNel").each(function() {
				$(this).removeClass('disabled');
			});
			$(".newBtnCom").each(function() {
				$(this).removeClass('disabled');
			});
			$(".newBtnRev").each(function() {
				$(this).removeClass('disabled');
			});
		}

		function flicker(index){
			var target='#uptDate'+index;
			$(target).addClass('red');
			$(target).fadeOut(500).fadeIn(500);
			var cidd=setInterval(function(){
				$(target).fadeOut(500).fadeIn(500);
			},1000);
			setTimeout(function(){  
				clearTimeout(cidd);
				$(target).stop().fadeIn('fast');
				$(target).removeClass('red');
				endRenderComments();
			}, 3000);
		}
		
		function checkAndOpenModal(target,cntNumber,cntTail,flag){
			var a=$("input[name='MoneyToLend']").val().toString().trim();
			var b=$("input[name='InterestRate']").val().toString().trim();
			var c=$("input[name='MonthPeriod']").val().toString().trim();
			var aa=parseInt(a);
			var bb=parseFloat(b);
			var cc=parseInt(c);
			var trueCnt;
			
			if(flag){
				if((a!=='')&&(b!=='')&&(c!=='')&&(aa>=1)&&(bb>=0.01)&&(bb<=99)&&(cc>=1)&&(cc<=36)){
					$("input[name='MoneyToLend']").val(aa);
					$("input[name='InterestRate']").val(bb);
					$("input[name='MonthPeriod']").val(cc);
					trueCnt='您確定要以金額 <span class="red">'+$("input[name='MoneyToLend']").val()+'元</span> 、年利率 <span class="red">'+$("input[name='InterestRate']").val()+'%</span> 、期數 <span class="red">'+$("input[name='MonthPeriod']").val()+'個月</span> 為條件向 <span class="red">'+$("#aiteName").text()+'</span> '+cntTail;
					$(cntNumber).html('<br>'+trueCnt+'<br><br>');
					$(target).modal('show');
				}else{
					$('#msgModal').modal('show');
				}
			}else{
				trueCnt=cntTail;
				$(cntNumber).html('<br>'+trueCnt+'<br><br>');
				$(target).modal('show');
			}
		}
		
		var dcFlag=false;
		function deleteComment(index){
			if(!dcFlag){
				startRenderComments();
				$.ajax({ 
					url: '/Discussions/destroy',
					type: 'POST',
					data:{_id:$('#hdIpt'+index).val()},
					dataType: 'json',
					success: function(Jdata) {
						if(Jdata.success){
							renderComments(Jdata);
						}else{
							alert(Jdata.error);
						}
						endRenderComments();
					},
					error: function() {
						alert('something wrong.');
						endRenderComments();
					}
				});
			}
		}
		
		function newLineMain(){
			$('#iptCtr').val($('#iptCtr').val()+'\n');
			$('#iptCtr').focus();
		}

		function newLine(index){
			$('#actionTa'+index).val($('#actionTa'+index).val()+'\n');
			$('#actionTa'+index).focus();
		}
		
		function startEdit(index){
			var content='<div class="input-group" style="width:70%;">';
			content+='<textarea id="actionTa'+index+'" class="form-control actionTa" style="height:35px;min-width:150px;" placeholder="ESC鍵可取消編輯" onkeypress="if(event.keyCode===13){if(!event.shiftKey){editComment('+index+');return false;}}" onkeyup="if(event.keyCode===27){endEdit('+index+');}">'+$('#hdIpt2'+index).val().replace(/&quot;/g,'"').replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&')+'</textarea>';
			content+='<span class="input-group-btn"><button class="btn btn-default newBtnNel" style="height:35px;" onclick="newLine('+index+');" type="button"><span class="glyphicon glyphicon-arrow-down myTitle2"></span></button><button class="btn btn-default newBtnCom" style="height:35px;" onclick="editComment('+index+');" type="button"><span class="glyphicon glyphicon-comment myTitle2"></span></button><button class="btn btn-default newBtnRev" style="height:35px;" onclick="endEdit('+index+');" type="button"><span class="glyphicon glyphicon-remove myTitle2"></span></button></span></div>';
			$('#cntIptDiv'+index).html(content);
		}
		
		function endEdit(index){
			$('#cntIptDiv'+index).html($('#hdIpt3'+index).val());
		}
		
		var ecFlag=false;
		function editComment(index){
			if(!ecFlag){
				if($('#actionTa'+index).val().toString().trim()!==''){
					startRenderComments();
					var savedID=$('#hdIpt'+index).val();
					$.ajax({ 
						url: '/Discussions/edit',
						type: 'POST',
						data:{_id:savedID,Content:$('#actionTa'+index).val()},
						dataType: 'json',
						success: function(Jdata) {
							if(Jdata.success){
								renderComments(Jdata);
							}else{
								alert(Jdata.error);
							}
							var foundFlag=false;
							for(i=0;i<Jdata.result.length-1;i++){
								var tempppe=$('#hdIpt'+i).val();
								if(tempppe===savedID){
									foundFlag=true;
									flicker(i);
									break;
								}
							}
							if(!foundFlag){
								alert('something wrong.');
								endRenderComments();
							}
						},
						error: function() {
							alert('something wrong.');
							endRenderComments();
						}
					});
				}
			}
		}
		
		var scFlag=false;
		function sendComment(){
			if(!scFlag){
				if($('#iptCtr').val().toString().trim()!==''){
					startRenderComments();
					$.ajax({ 
							url: '/Discussions/create',
							type: 'POST',
							data:{Content:$('#iptCtr').val().toString().trim(),BelongTo:"<%=json._id%>"},
							dataType: 'json',
							success: function(Jdata) {
								if(Jdata.success){
									renderComments(Jdata);
									$('#discussionDiv').stop().animate({
									  scrollTop: $("#discussionDiv")[0].scrollHeight
									}, 800);
									$('#iptCtr').val('');
								}else{
									alert(Jdata.error);
								}
								endRenderComments();
							},
							error: function() {
								alert('something wrong.');
								endRenderComments();
							}
					});	
				}
			}
		}

		<%if(!ifSelf){ %>
			function like(){
				$('#btnID').addClass('disabled');
				$.ajax({ 
						url: '/Borrows/like',
						type: 'POST',
						data:{_id:"<%=json._id%>"},
						dataType: 'json',
						success: function(Jdata) {
							if(Jdata.success){
								var dateObj=new Date(Jdata.date);
								var zeroMonth='';
								if(dateObj.getMonth()<9){
									zeroMonth='0';
								}
								var zeroDate='';
								if(dateObj.getDate()<10){
									zeroDate='0';
								}
								$('#updatedDate').html(dateObj.getFullYear()+'/'+zeroMonth+(dateObj.getMonth()+1)+'/'+zeroDate+dateObj.getDate());
								$('#likeBtn').html('<button class="btn btn-default" onclick="unlike();" id="btnID"><span class="glyphicon glyphicon-remove myTitle2"></span></button>');
								$('#likeNum').html('&nbsp;'+Jdata.result);
							}else{
								alert('something wrong.');
								$('#btnID').removeClass('disabled');
							}
						},
						error: function() {
							alert('something wrong.');
							$('#btnID').removeClass('disabled');
						}
				});	
			}
			
			function unlike(){
				$('#btnID').addClass('disabled');
				$.ajax({ 
						url: '/Borrows/unlike',
						type: 'POST',
						data:{_id:"<%=json._id%>"},
						dataType: 'json',
						success: function(Jdata) {
							if(Jdata.success){
								var dateObj=new Date(Jdata.date);
								var zeroMonth='';
								if(dateObj.getMonth()<9){
									zeroMonth='0';
								}
								var zeroDate='';
								if(dateObj.getDate()<10){
									zeroDate='0';
								}
								$('#updatedDate').html(dateObj.getFullYear()+'/'+zeroMonth+(dateObj.getMonth()+1)+'/'+zeroDate+dateObj.getDate());
								$('#likeBtn').html('<button class="btn btn-default" onclick="like();" id="btnID"><span class="glyphicon glyphicon-thumbs-up myTitle2"></span></button>');
								$('#likeNum').html('&nbsp;'+Jdata.result);
							}else{
								alert('something wrong.');
								$('#btnID').removeClass('disabled');
							}
						},
						error: function() {
							alert('something wrong.');
							$('#btnID').removeClass('disabled');
						}
				});	
			}
			
			function interestInFutureCalculator(){
				if(($("input[name='MoneyToLend']").val().toString().trim()!=='')&&($("input[name='InterestRate']").val().toString().trim()!=='')&&($("input[name='MonthPeriod']").val().toString().trim()!=='')){
					var money=parseInt($("input[name='MoneyToLend']").val().toString().trim());
					var rate=parseFloat($("input[name='InterestRate']").val().toString().trim());
					var month=parseInt($("input[name='MonthPeriod']").val().toString().trim());
					if((!isNaN(month))&&(!isNaN(money))&&(!isNaN(rate))&&(month>=1)&&(month<=36)&&(money>=1)&&(rate>=0.01)&&(rate<=99)){
						rate/=100;
						rate/=12;
						var interestFuture=0;
						var tempMoney=money;
						var tempMonth=month;
						for(i=0;i<month;i++){
							if(tempMoney>0){
								interestFuture+=Math.round(tempMoney*rate);
								var monthlyPaid=Math.floor(tempMoney/tempMonth);
								if(tempMonth>1){
									tempMoney-=monthlyPaid;
								}else{
									tempMoney-=tempMoney;
								}
								tempMonth-=1;
								if(tempMoney<0){
									tempMoney=0;
								}
							}
						}
						var moneyFuture=interestFuture+money;
						var interestFutureDivMoney
						if(money>0){
							interestFutureDivMoney=interestFuture/money*100;
						}else{
							interestFutureDivMoney=0;
						}
						var interestFutureMonth;
						if(month>0){
							interestFutureMonth=interestFuture/month;
						}else{
							interestFutureMonth=0;
						}
						var interestFutureMoneyMonth;
						if(month>0){
							interestFutureMoneyMonth=(interestFuture+money)/month;
						}else{
							interestFutureMoneyMonth=0;
						}
						
						$("#interestFuture").val(interestFuture.toFixed(0));
						$("#interestFutureMonth").val(interestFutureMonth.toFixed(0));
						$("#interestFutureMoneyMonth").val(interestFutureMoneyMonth.toFixed(0));
						$("#interestFutureDivMoney").val(interestFutureDivMoney.toFixed(2));
						$("#moneyFuture").val(moneyFuture.toFixed(0));
					}else{
						$("#interestFuture").val('錯誤參數，無法進行試算!');
						$("#interestFutureMonth").val('錯誤參數，無法進行試算!');
						$("#interestFutureMoneyMonth").val('錯誤參數，無法進行試算!');
						$("#interestFutureDivMoney").val('錯誤參數，無法進行試算!');
						$("#moneyFuture").val('錯誤參數，無法進行試算!');
					}					
				}else{
					$("#interestFuture").val('錯誤參數，無法進行試算!');
					$("#interestFutureMonth").val('錯誤參數，無法進行試算!');
					$("#interestFutureMoneyMonth").val('錯誤參數，無法進行試算!');
					$("#interestFutureDivMoney").val('錯誤參數，無法進行試算!');
					$("#moneyFuture").val('錯誤參數，無法進行試算!');
				}
			}
			
			
			var submitFlag=false;
			<%if(jsonLend){%>	
				var lendChangerFlag=false;
				function lendChanger(){
					if(!lendChangerFlag){
						var temp=$('#lendChangerIpt').val().toString().trim();
						if(temp!==''){
							ajaxer(temp);
						}else{
							$('#s0').html('&nbsp;&nbsp;&nbsp;&nbsp;不可為空值！');
						}
					}
				}
				
				function ajaxer(value){
					$('#s0').html('&nbsp;&nbsp;&nbsp;&nbsp;處理中...');
					starter();
					$.ajax({ 
						url: '/Lends/changer',
						type: 'POST',
						data:{Value:value,TargetID:"<%=jsonLend._id%>"},
						dataType: 'json',
						success: function(Jdata) {
							if(Jdata.success){
								$('#lendChangerIpt0').val(Jdata.result0.toFixed(0));
								$('#lendChangerIpt1').val(Jdata.result.maxSettingAutoLend.toFixed(0));
								$('#lendChangerIpt2').val(Jdata.result.moneyLendedCumulated.toFixed(0));
								$('#lendChangerIpt3').val(Jdata.result.hendLendCumulated.toFixed(0));
								$('#lendChangerIpt4').val(Jdata.result.moneyLeftToHendLend.toFixed(0));
								$('#lendChangerIpt5').val(Jdata.result.autoLendCumulated.toFixed(0));
								$('#lendChangerIpt6').val(Jdata.result.moneyLeftToAutoLend.toFixed(0));
								$('#lendChangerIpt').val(Jdata.result.maxMoneyToLend.toFixed(0));
								$('#s0').html('&nbsp;&nbsp;&nbsp;&nbsp;成功修改！');
							}else{
								if(Jdata.result0){
									$('#lendChangerIpt0').val(Jdata.result0.toFixed(0));
								}
								if(Jdata.origValue){
									$('#lendChangerIpt').val(Jdata.origValue.toFixed(0));
								}
								$('#s0').html('&nbsp;&nbsp;&nbsp;&nbsp;'+Jdata.error);
							}
							ender();
						},
						error: function() {
							$('#s0').html('&nbsp;&nbsp;&nbsp;&nbsp;something wrong!');
							ender();
						}
					});	
				}
				
				function starter(){
					lendChangerFlag=true;
					$('#lendChangerIpt').attr('onkeypress','');
					$('#lendChangerIpt').attr('readonly','readonly');
					$('#lendChangerBtn').addClass('disabled');
					
					submitFlag=true;
					disableButtonInner();
				}
				
				function ender(){
					lendChangerFlag=false;
					$('#lendChangerIpt').attr('onkeypress','if(event.keyCode===13){lendChanger();}');
					$('#lendChangerIpt').removeAttr("readonly");
					$('#lendChangerBtn').removeClass('disabled');
					
					submitFlag=false;
					enableButtonInner();
				}
			<%}%>
			
			<%if(!jsonBorrowMessage){%>
				<% if(!jsonMessage){ %>
					<%if(json.IfReadable){ %>
						function create(){
							$('#chkModal1').modal('hide');
						}
						
						function disableButton(){
							if(!submitFlag){
								disableButtonInner();
								submitFlag=true;
								return true;
							}else{
								return false;
							}
						}
						
						function disableButtonInner(){
							$('#createBtnID').addClass('disabled');
						}
						
						function enableButtonInner(){
							$('#createBtnID').removeClass('disabled');
						}
					<%}%>
				<%}else{%>
					<%if((json.IfReadable)&&(jsonMessage.Status==='NotConfirmed')){ %>
						function destroy(){
							$('#chkModal3').modal('hide');
							disableButton();
							
							var form=document.getElementById('formID');
							form.action="/Messages/destroy";
							form.submit();
						}
						
						function update(){
							$('#chkModal2').modal('hide');
						}
						
						function disableButton(){
							if(!submitFlag){
								disableButtonInner();
								submitFlag=true;
								return true;
							}else{
								return false;
							}
						}
						
						function disableButtonInner(){
							$('#destroyBtnID').addClass('disabled');
							$('#updateBtnID').addClass('disabled');
						}
						
						function enableButtonInner(){
							$('#destroyBtnID').removeClass('disabled');
							$('#updateBtnID').removeClass('disabled');
						}
					<%}else if((!json.IfReadable)&&(jsonMessage.Status==='NotConfirmed')){%>
						function destroy(){
							$('#chkModal7').modal('hide');
						}
						
						function disableButton(){
							if(!submitFlag){
								disableButtonInner();
								submitFlag=true;
								return true;
							}else{
								return false;
							}
						}
						
						function disableButtonInner(){
							$('#destroyBtnID').addClass('disabled');
						}
						
						function enableButtonInner(){
							$('#destroyBtnID').removeClass('disabled');
						}
					<%}%>
				<%}%>
			<%}else{%>
				<%if((json.IfReadable)&&(jsonBorrowMessage.Status==='NotConfirmed')){ %>
					<%if(jsonLend){%>
						function agree(){
							$('#chkModal4').modal('hide');
						}
					<%}%>
					
					function refuse(){
						$('#chkModal5').modal('hide');
						disableButton(2);
						
						var form=document.getElementById('confirmFormID');
						form.action="/Messages/rejectToBorrowMessageInStory";
						form.submit();
					}
					
					<%if(jsonLend){%>
						var jsonLendFlag=true;
					<%}else{%>
						var jsonLendFlag=false;
					<%}%>
					
					function disableButton(side){
						if(!submitFlag){
							if(jsonLendFlag){
								disableButtonInner();
								submitFlag=true;
								return true;
							}else{
								if(side===1){
									$('#chkModal4').modal('show');
									return false;
								}else if(side===2){
									disableButtonInner();
									submitFlag=true;
									return true;
								}
							}
						}else{
							return false;
						}
					}
					
					function disableButtonInner(){
						$('#rfsBtnID').addClass('disabled');

						if(jsonLendFlag){
							$('#argBtnID').addClass('disabled');
						}
					}
					
					function enableButtonInner(){
						$('#rfsBtnID').removeClass('disabled');
						
						if(jsonLendFlag){
							$('#argBtnID').removeClass('disabled');
						}
					}
				<%}else if((!json.IfReadable)&&(jsonBorrowMessage.Status==='NotConfirmed')){%>
					function refuse(){
						$('#chkModal6').modal('hide');
					}
					
					function disableButton(){
						if(!submitFlag){
							disableButtonInner();
							submitFlag=true;
							return true;
						}else{
							return false;
						}
					}
					
					function disableButtonInner(){
						$('#rfsBtnID').addClass('disabled');
					}
					
					function enableButtonInner(){
						$('#rfsBtnID').removeClass('disabled');
					}
				<%}%>
			<%}%>	
		<%}else{%>
			<%if(json.IfReadable){ %>
				function readable(){
					$('#readableModal').modal('hide');
				}
				
				function disableButton(){
					if(!submitFlag){
						disableButtonInner();
						submitFlag=true;
						return true;
					}else{
						return false;
					}
				}
				
				function disableButtonInner(){
					$('#readableBtnID').addClass('disabled');
				}
				
				function enableButtonInner(){
					$('#readableBtnID').removeClass('disabled');
				}
			<%}%>
		<%}%>
	<%}%>
</script>
<%- include('layout_footer',{imgSettingCode:"var ifLoadedCount=0;",imgDrawingCode:"",nav_cur:'story'}); -%>