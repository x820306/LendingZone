<%- include('layout_header',{searchTitle:null,nav_cur:'message',actionDefault:'建立日期',directorDefault:'大至小',keywordDefault:'',categoryDefault:'不分類'}); -%>
<div class="container">
	<div class="row">
		<center>
			<form method = "post" action= "/Users/changePW" onsubmit="return disableButton();">
				<h3>變更密碼<br></h3>
				<div class="input-group">
					<label for="nPwdIpt0">舊密碼</label>
					<input type="password" class="form-control" id="oldPwdIpt" name="OldPassword" placeholder="請輸入舊密碼" required="required" onblur="ifOldPWRight(true);return false;" onkeyup="value=value.replace(/[^\w\.\/]/ig,'');return false;"><br><span id="confirmMessage1" class="confirmMessage1"></span>
				</div>
				<br>
				<div class="input-group">
					<label for="nPwdIpt">新密碼</label>
					<input type="password" class="form-control" id="PwdIpt" name="Password" placeholder="請輸入新密碼" required="required" onkeyup="value=value.replace(/[^\w\.\/]/ig,'');checkLength(); return false;"><br><span id="confirmMessage2" class="confirmMessage2"></span>
				</div>
				<br>
				<div class="input-group">
					<label for="n2PwdIpt">新密碼確認</label>
					<input type="password" class="form-control" id="2PwdIpt" name="Password2nd" placeholder="新密碼確認" required="required" onkeyup="value=value.replace(/[^\w\.\/]/ig,'');checkPwd(); return false;"> <br><span id="confirmMessage3" class="confirmMessage3"></span>
				</div>
				<br>
				<div class="btn-toolbar" role="toolbar" style = "margin-top: 10px;">
				<button id="subBtnID" type="submit" class="btn btn-default btn-lg">
					  <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> 確認
				</button>
				<button id="cancelBtnID" type="button" class="btn btn-default btn-lg" onClick = "javascript:location.href='/'" >
					  <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 關閉
				</button></div>
			</form>
		</center>
	</div>
</div>
<script>
	var valiFlag1=false;
	var valiFlag2=false;
	var submitFlag=false;
	
	function start(){
		var orig=$('#subBtnID').attr('class');
		if(orig.search(' disabled')<0){
			orig=orig+' disabled';
			$('#subBtnID').attr('class',orig);
		}
		orig=$('#cancelBtnID').attr('class');
		if(orig.search(' disabled')<0){
			orig=orig+' disabled';
			$('#cancelBtnID').attr('class',orig);
		}
	}
	
	function end(){
		var orig=$('#subBtnID').attr('class');
		orig=orig.replace(/ disabled/g, '');
		$('#subBtnID').attr('class',orig);
		
		orig=$('#cancelBtnID').attr('class');
		orig=orig.replace(/ disabled/g, '');
		$('#cancelBtnID').attr('class',orig);
	}
	
	function disableButton(){
		if(!submitFlag){
			submitFlag=true;
			start();
			ifOldPWRight(false);
			checkLength();
			checkPwd();
			if(!valiFlag1){
				$('#oldPwdIpt').focus();
				submitFlag=false;
				end();
				return false;
			}else if(!valiFlag2){
				$('#PwdIpt').focus();
				submitFlag=false;
				end();
				return false;
			}else if(!valiFlag3){
				$('#2PwdIpt').focus();
				submitFlag=false;
				end();
				return false;
			}else{
				return true;
			}
		}else{
			return false;
		}
	}
	
	function ifOldPWRight(asyncFlag)
	{
	    var oldPW = $('#oldPwdIpt').val().trim();
		if(oldPW!=''){
			$('#confirmMessage1').html('正在比對中');
			$.ajax({ 
				url: '/Users/ifOldPWRight',
				type: 'POST',
				async: asyncFlag,
				data:{OldPassword:oldPW},
				dataType: 'json',
				success: function(Jdata) {
					if(Jdata.success){
						if(Jdata.Right){
							$('#confirmMessage1').html('舊密碼輸入正確！');
							valiFlag1=true;
						}else{
							$('#confirmMessage1').html('舊密碼輸入錯誤！');
							valiFlag1=false;
						}
					}else{
						$('#confirmMessage1').html(Jdata.error);
						valiFlag1=false;
					}
				},
				error: function() {
					$('#confirmMessage1').html('something wrong');
					valiFlag1=false;
				}
			});
		}
	}
	
	function checkLength()
	{
	    var pwd1 = $('#PwdIpt').val().trim();
	    if(pwd1.length<6){
	        $('#confirmMessage2').html('密碼須大於六碼');
			valiFlag2=false;
	    }else{
	        $('#confirmMessage2').html('密碼長度符合條件');
			valiFlag2=true;
	    }
	}
	
	function checkPwd()
	{
	    var pwd1 = $('#PwdIpt').val().trim();
	    var pwd2 = $('#2PwdIpt').val().trim();
	    if(pwd1 == pwd2){
	        $('#confirmMessage3').html('輸入密碼相同');
			valiFlag3=true;
	    }else{
	        $('#confirmMessage3').html('請再次確認您輸入的密碼是否相同');
			valiFlag3=false;
	    }
	}
</script>
<%- include('layout_footer',{imgSettingCode:"var ifLoadedCount=0;",imgDrawingCode:""}); -%>